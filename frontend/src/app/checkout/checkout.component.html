<div class="container mt-4">
    <div *ngIf="loading" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Preparing your checkout...</p>
    </div>

    <!-- Main Content -->
    <div class="row" *ngIf="!loading && cart && cart.cartItems && cart.cartItems.length > 0">
        <!-- Stepper / Left Side -->
        <div class="col-md-8">

            <!-- Step 1: Shipping Address -->
            <div class="card shadow-sm border-0 rounded-4 mb-4" [class.opacity-50]="currentStep !== 1">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold" [class.text-primary]="currentStep === 1">
                        <i class="bi bi-geo-alt-fill me-2"></i>1. Shipping Address
                    </h5>
                </div>
                <div class="card-body p-4" *ngIf="currentStep === 1">
                    <div *ngIf="savedAddresses.length > 0" class="mb-4">
                        <h6 class="fw-bold mb-3">Saved Addresses</h6>
                        <div class="list-group">
                            <label class="list-group-item d-flex gap-3" *ngFor="let addr of savedAddresses">
                                <input class="form-check-input flex-shrink-0" type="radio" name="address"
                                    [value]="addr.id" [(ngModel)]="selectedAddressId" (change)="useNewAddress = false">
                                <span>
                                    <strong>{{addr.label}}</strong><br>
                                    <small>{{addr.street}}, {{addr.city}}, {{addr.zipCode}}</small>
                                </span>
                            </label>
                            <label class="list-group-item d-flex gap-3">
                                <input class="form-check-input flex-shrink-0" type="radio" name="address" [value]="null"
                                    [checked]="useNewAddress" (change)="useNewAddress = true; selectedAddressId = null">
                                <span>
                                    <strong>Add New Address</strong>
                                </span>
                            </label>
                        </div>
                    </div>

                    <div *ngIf="useNewAddress || savedAddresses.length === 0"
                        class="mt-3 animate__animated animate__fadeIn">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label small fw-bold">Street Address</label>
                                <input type="text" class="form-control" [(ngModel)]="newAddress.street"
                                    placeholder="123 Main St">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">City</label>
                                <input type="text" class="form-control" [(ngModel)]="newAddress.city"
                                    placeholder="New York">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Zip Code</label>
                                <input type="text" class="form-control" [(ngModel)]="newAddress.zipCode"
                                    placeholder="10001">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">State</label>
                                <input type="text" class="form-control" [(ngModel)]="newAddress.state" placeholder="NY">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Country</label>
                                <input type="text" class="form-control" [(ngModel)]="newAddress.country"
                                    placeholder="USA">
                            </div>
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button class="btn btn-primary rounded-pill px-4" (click)="proceedToPayment()">
                            Continue to Payment <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" *ngIf="currentStep > 1">
                    <p class="mb-0 text-success"><i
                            class="bi bi-check-circle-fill me-2"></i>{{formattedShippingAddress}}</p>
                </div>
            </div>

            <!-- Step 2: Payment Method -->
            <div class="card shadow-sm border-0 rounded-4 mb-4" [class.opacity-50]="currentStep !== 2">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold" [class.text-primary]="currentStep === 2">
                        <i class="bi bi-credit-card-fill me-2"></i>2. Payment Method
                    </h5>
                </div>
                <div class="card-body p-4" *ngIf="currentStep === 2">

                    <!-- Saved Payments List -->
                    <div *ngIf="savedPayments.length > 0" class="mb-4">
                        <h6 class="fw-bold mb-3">Saved Payment Methods</h6>
                        <div class="list-group">
                            <label class="list-group-item d-flex gap-3" *ngFor="let payment of savedPayments">
                                <input class="form-check-input flex-shrink-0" type="radio" name="paymentMethod"
                                    [value]="payment.id" [(ngModel)]="selectedPaymentId"
                                    (change)="useNewPayment = false">
                                <span>
                                    <strong>{{payment.provider}} {{payment.maskedNumber}}</strong><br>
                                    <small *ngIf="payment.cardHolderName"
                                        class="text-muted">{{payment.cardHolderName}}</small>
                                </span>
                            </label>
                            <label class="list-group-item d-flex gap-3">
                                <input class="form-check-input flex-shrink-0" type="radio" name="paymentMethod"
                                    [value]="null" [checked]="useNewPayment"
                                    (change)="useNewPayment = true; selectedPaymentId = null">
                                <span>
                                    <strong>Add New Payment Method</strong>
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Payment Options Tabs (New Payment) -->
                    <div *ngIf="useNewPayment || savedPayments.length === 0" class="animate__animated animate__fadeIn">
                        <ul class="nav nav-pills mb-3 gap-2" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link" [class.active]="paymentMethodType === 'CREDIT_CARD'"
                                    (click)="paymentMethodType = 'CREDIT_CARD'; useNewPayment = true">Credit/Debit
                                    Card</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" [class.active]="paymentMethodType === 'UPI'"
                                    (click)="paymentMethodType = 'UPI'; useNewPayment = true">UPI</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" [class.active]="paymentMethodType === 'NET_BANKING'"
                                    (click)="paymentMethodType = 'NET_BANKING'; useNewPayment = true">Net
                                    Banking</button>
                            </li>
                        </ul>

                        <div class="tab-content mt-4">
                            <!-- Card Form -->
                            <div *ngIf="paymentMethodType === 'CREDIT_CARD' || paymentMethodType === 'DEBIT_CARD'"
                                class="animate__animated animate__fadeIn">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label small fw-bold">Card Number</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-credit-card"></i></span>
                                            <input type="text" class="form-control"
                                                [(ngModel)]="newPaymentDetails.cardNumber"
                                                placeholder="0000 0000 0000 0000">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold">Card Holder Name</label>
                                        <input type="text" class="form-control"
                                            [(ngModel)]="newPaymentDetails.cardHolderName" placeholder="John Doe">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small fw-bold">Expiry</label>
                                        <input type="text" class="form-control"
                                            [(ngModel)]="newPaymentDetails.expiryDate" placeholder="MM/YY">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small fw-bold">CVV</label>
                                        <input type="password" class="form-control" [(ngModel)]="newPaymentDetails.cvv"
                                            placeholder="123">
                                    </div>
                                </div>
                            </div>

                            <!-- UPI Form -->
                            <div *ngIf="paymentMethodType === 'UPI'" class="animate__animated animate__fadeIn">
                                <label class="form-label small fw-bold">UPI ID</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" [(ngModel)]="newPaymentDetails.upiId"
                                        placeholder="user@upi">
                                    <button class="btn btn-outline-secondary">Verify</button>
                                </div>
                                <div class="form-text">Open your UPI app to approve payment after placing order.</div>
                            </div>
                        </div>
                    </div>

                    <div class="text-end mt-4 d-flex justify-content-between">
                        <button class="btn btn-link text-muted" (click)="currentStep = 1">Back</button>
                        <button class="btn btn-primary rounded-pill px-4" (click)="proceedToReview()">
                            Review Order <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" *ngIf="currentStep > 2">
                    <p class="mb-0 text-success"><i class="bi bi-check-circle-fill me-2"></i>Payment Details
                        Selected
                    </p>
                </div>
            </div>

            <!-- Step 3: Review -->
            <div class="card shadow-sm border-0 rounded-4 mb-4" [class.opacity-50]="currentStep !== 3">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold" [class.text-primary]="currentStep === 3">
                        <i class="bi bi-bag-check-fill me-2"></i>3. Review & Pay
                    </h5>
                </div>
                <div class="card-body p-4" *ngIf="currentStep === 3">
                    <div class="alert alert-light border rounded-3 mb-3">
                        <h6 class="fw-bold"><i class="bi bi-box-seam me-2"></i>Items</h6>
                        <div *ngFor="let item of cart.cartItems"
                            class="d-flex align-items-center justify-content-between mb-2 p-2 border-bottom small">
                            <div class="d-flex align-items-center gap-3">
                                <img [src]="item.product?.mainImageUrl" [alt]="item.product?.name"
                                    class="rounded border" style="width: 50px; height: 50px; object-fit: cover;"
                                    onerror="this.src='assets/img/product-placeholder.png'">
                                <div>
                                    <div class="fw-bold">{{item.product?.name}}</div>
                                    <div class="text-muted">Qty: {{item.quantity}}</div>
                                </div>
                            </div>
                            <div class="fw-bold text-primary">{{item.price * item.quantity | currency:'INR':'symbol'}}
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg rounded-pill fw-bold" (click)="placeOrder()"
                            [disabled]="processing">
                            <span *ngIf="processing" class="spinner-border spinner-border-sm me-2"></span>
                            Pay {{grandTotal | currency:'INR':'symbol'}}
                        </button>
                    </div>
                    <div class="text-start mt-2">
                        <button class="btn btn-link text-muted btn-sm" (click)="currentStep = 2">Back to
                            Payment</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Order Summary Sidebar -->
        <div class="col-md-4">
            <div class="card shadow-sm border-0 rounded-4 sticky-top" style="top: 100px;">
                <div class="card-header bg-dark text-white py-3 border-0">
                    <h5 class="mb-0 fw-bold">Order Summary</h5>
                </div>
                <div class="card-body p-4">
                    <!-- Coupon Section -->
                    <div class="mb-4 p-3 bg-light rounded">
                        <h6 class="fw-bold mb-3"><i class="bi bi-tag-fill me-2"></i>Apply Coupon</h6>
                        <div *ngIf="!appliedCoupon">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" placeholder="Enter coupon code"
                                    [(ngModel)]="couponCode" (keyup.enter)="applyCoupon()"
                                    [class.is-invalid]="couponError">
                                <button class="btn btn-primary" type="button" (click)="applyCoupon()">
                                    Apply
                                </button>
                            </div>
                            <div *ngIf="couponError" class="text-danger small">
                                <i class="bi bi-exclamation-circle me-1"></i>{{couponError}}
                            </div>
                        </div>
                        <div *ngIf="appliedCoupon" class="alert alert-success mb-0 p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{appliedCoupon.code}}</strong>
                                    <div class="small">{{appliedCoupon.description}}</div>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" (click)="removeCoupon()">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal</span>
                        <span>{{cart.totalAmount | currency:'INR':'symbol'}}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-success" *ngIf="discountAmount > 0">
                        <span><i class="bi bi-tag-fill me-1"></i>Discount</span>
                        <span>-{{discountAmount | currency:'INR':'symbol'}}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping</span>
                        <span class="text-muted">Free</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="h5 fw-bold mb-0">Total</span>
                        <span class="h4 fw-bold text-primary mb-0">{{grandTotal |
                            currency:'INR':'symbol'}}</span>
                    </div>
                </div>
                <div class="card-footer bg-light p-3 small text-muted text-center">
                    <i class="bi bi-shield-lock me-1"></i> Secure Checkout
                </div>
            </div>
        </div>
    </div>
</div>